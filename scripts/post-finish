#!/bin/bash
#
# TUS Post-Finish Hook Script for 3Speak Upload Service
#

# Configuration
CALLBACK_URL="http://localhost:8080/api/upload/tus-callback"
TIMEOUT=30
UPLOAD_DIR="/tmp/uploads"

# Log function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >&2
}

# Validate TUS environment variables
if [[ -z "$TUS_ID" ]]; then
    log_message "ERROR: TUS_ID not provided"
    exit 1
fi

log_message "Processing upload completion for ID: $TUS_ID"

# Construct file path (TUS stores files as upload_id in upload directory)
TUS_FILE="$UPLOAD_DIR/$TUS_ID"

if [[ ! -f "$TUS_FILE" ]]; then
    # Try with .bin extension (some TUS servers use this)
    TUS_FILE="$UPLOAD_DIR/${TUS_ID}.bin"
    if [[ ! -f "$TUS_FILE" ]]; then
        log_message "ERROR: Upload file not found at $TUS_FILE"
        exit 1
    fi
fi

log_message "Found upload file: $TUS_FILE"

# Get file size
FILE_SIZE=$(stat -c%s "$TUS_FILE" 2>/dev/null || echo "0")
log_message "File size: $FILE_SIZE bytes"

# For now, we'll get metadata from the TUS info file or pass basic info
# TUS stores metadata in .info files
INFO_FILE="$UPLOAD_DIR/${TUS_ID}.info"

if [[ -f "$INFO_FILE" ]]; then
    log_message "Found TUS info file: $INFO_FILE"
    # Extract metadata from info file if it exists
    VIDEO_ID=$(grep -o '"video_id":"[^"]*"' "$INFO_FILE" 2>/dev/null | cut -d'"' -f4)
    FILENAME=$(grep -o '"filename":"[^"]*"' "$INFO_FILE" 2>/dev/null | cut -d'"' -f4)
else
    log_message "No TUS info file found, using defaults"
    VIDEO_ID=""
    FILENAME="upload.mp4"
fi

log_message "Extracted metadata - Video ID: $VIDEO_ID, Filename: $FILENAME"

# Get additional metadata by looking up video in database via API
if [[ -n "$VIDEO_ID" ]]; then
    log_message "Looking up video metadata for: $VIDEO_ID"
    
    # Call our own API to get video details
    VIDEO_INFO=$(curl -s -X GET "http://localhost:8080/api/upload/video/$VIDEO_ID/status" \
        -H "Authorization: Bearer your-super-secret-upload-token-here-change-this-in-production" 2>/dev/null)
    
    if [[ $? -eq 0 && -n "$VIDEO_INFO" ]]; then
        # Extract owner and permlink from the response
        OWNER=$(echo "$VIDEO_INFO" | grep -o '"owner":"[^"]*"' | cut -d'"' -f4)
        PERMLINK=$(echo "$VIDEO_INFO" | grep -o '"permlink":"[^"]*"' | cut -d'"' -f4)
        log_message "Found metadata - Owner: $OWNER, Permlink: $PERMLINK"
    else
        log_message "WARNING: Could not fetch video metadata, using defaults"
        OWNER="unknown"
        PERMLINK="unknown"
    fi
else
    log_message "WARNING: No video_id provided, using defaults"
    OWNER="unknown" 
    PERMLINK="unknown"
fi

# Prepare callback payload
UPLOAD_DATA=$(cat <<EOF
{
  "Upload": {
    "ID": "$TUS_ID",
    "Storage": {
      "Path": "$TUS_FILE"
    },
    "MetaData": {
      "video_id": "$VIDEO_ID",
      "owner": "$OWNER",
      "permlink": "$PERMLINK",
      "filename": "$FILENAME"
    },
    "SizeBytes": $FILE_SIZE
  }
}
EOF
)

# Send callback to upload service
log_message "Sending callback to: $CALLBACK_URL"

HTTP_STATUS=$(curl -w "%{http_code}" -o /tmp/tus_callback_response.txt \
  --max-time "$TIMEOUT" \
  --retry 3 \
  --retry-delay 2 \
  -X POST \
  -H "Content-Type: application/json" \
  -d "$UPLOAD_DATA" \
  "$CALLBACK_URL" 2>/dev/null)

CURL_EXIT_CODE=$?

if [[ $CURL_EXIT_CODE -eq 0 && "$HTTP_STATUS" =~ ^2[0-9][0-9]$ ]]; then
    log_message "SUCCESS: Callback sent successfully (HTTP $HTTP_STATUS)"
    
    # Log response if needed
    if [[ -s /tmp/tus_callback_response.txt ]]; then
        RESPONSE_BODY=$(cat /tmp/tus_callback_response.txt)
        log_message "Response: $RESPONSE_BODY"
    fi
    
    # Cleanup response file
    rm -f /tmp/tus_callback_response.txt
    
    exit 0
else
    log_message "ERROR: Callback failed (curl exit: $CURL_EXIT_CODE, HTTP: $HTTP_STATUS)"
    
    # Log error response
    if [[ -s /tmp/tus_callback_response.txt ]]; then
        ERROR_RESPONSE=$(cat /tmp/tus_callback_response.txt)
        log_message "Error response: $ERROR_RESPONSE"
    fi
    
    # Cleanup response file
    rm -f /tmp/tus_callback_response.txt
    
    exit 1
fi